openapi: 3.0.3
info:
  title: Virtual Cuppa API
  description: |
    Backend API for Virtual Cuppa application with email-based authentication and automatic matching system.

    ## Features
    - Email-based authentication with 6-digit codes
    - User tagging system for better matching
    - Automatic match generation every Monday at 9 AM
    - Manual match triggering for admins
    - Match acceptance/rejection workflow
    - SendGrid email notifications

    ## Matching System
    The system automatically generates matches between users based on:
    - **Tag compatibility**: Jaccard similarity (common tags / total unique tags × 100)
    - **Availability configuration**: Both users must have availability configuration with at least one common time slot
    - **User status**: No pending matches
    - **Cooldown period**: 30-day minimum between same users
    - **One match per user**: Each user can have only one pending match at a time

    ### Availability Configuration (Required for Matching)
    - Each user must create their **system-wide availability configuration**
    - Configuration defines available days (Monday-Sunday) and periods (morning/afternoon)
    - **Matching requirement**: Both users must have:
      1. Created availability configuration
      2. At least one common time slot (e.g., both available Tuesday afternoon)
    - Users without configuration **will not be matched**

    ### Match Generation Algorithm
    1. Filter users: confirmed, no pending match, **has availability config**
    2. For each pair: check recent match history (30 days) and **common availability**
    3. Calculate compatibility score based on tags
    4. Sort pairs by score (highest first)
    5. Greedy selection: pick best matches ensuring each user appears once

    ### Match Acceptance Flow
    - **Two-step acceptance**: Both users must accept for the match to be fully accepted
    - Match remains **pending** until both users accept
    - If first user accepts, match stays pending for the second user
    - Once both accept, status changes to **accepted**
    - If either user rejects, status immediately changes to **rejected**

    ### Automatic Scheduler
    - Runs every **30 minutes**
    - Processes **all organisations** automatically
    - Can be manually triggered via `/api/admin/matches/trigger-scheduler`
    - Additionally triggers when user confirms account or after both users submit feedback

    ## Email Notifications
    The system uses SendGrid with four email templates:

    1. **CONFIRM_CODE_TEMPLATE_ID**: 6-digit confirmation code
       - Sent during registration
       - Sent when user requests a new code
       - Dynamic data: `confirmCode`

    2. **INVITATION_TEMPLATE_ID**: User invitation
       - Sent when admin creates a new user
       - Dynamic data: `OrganisationName`

    3. **MATCH_ACCEPTED_TEMPLATE_ID**: Match acceptance notification
       - Sent to both users when both have accepted a match
       - Dynamic data: `MatchName` (other user's name), `Availability` (formatted HTML with both users' time slots)

  version: 2.0.0
  contact:
    email: noreply@notacv.com

servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Authentication
    description: User authentication and registration endpoints
  - name: User
    description: User profile and match endpoints
  - name: Availability
    description: User availability configuration for matching
  - name: Admin
    description: Admin-only endpoints for user management, organisation settings, and match control
  - name: Matches
    description: Match generation and management endpoints

paths:
  /health:
    get:
      summary: Health check
      description: Check if the server is running
      responses:
        "200":
          description: Server is running
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  message:
                    type: string
                    example: Server is running

  /api/auth/register:
    post:
      tags:
        - Authentication
      summary: Register a new user
      description: Register a new Admin account. A confirmation code will be sent to the user's email. After registration, user must login to receive access tokens.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                firstName:
                  type: string
                  example: John
                lastName:
                  type: string
                  example: Doe
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        "201":
          description: Registration successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Registration successful. Confirmation code sent to email
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: User already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/auth/request-code:
    post:
      tags:
        - Authentication
      summary: Request a confirmation code
      description: Request a 6-digit confirmation code to be sent via email (valid for 5 minutes)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        "200":
          description: Confirmation code sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Confirmation code sent to email
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/auth/login:
    post:
      tags:
        - Authentication
      summary: Login with confirmation code
      description: Login using email and 6-digit confirmation code received via email
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - confirmCode
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                confirmCode:
                  type: string
                  minLength: 6
                  maxLength: 6
                  example: "123456"
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: Get a new access token using refresh token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
                  example: refresh.token.here
      responses:
        "200":
          description: Token refreshed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "401":
          description: Invalid refresh token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/profile:
    get:
      tags:
        - User
      summary: Get current user profile
      description: Get the profile of the currently authenticated user
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/organisation:
    get:
      tags:
        - User
      summary: Get organisation
      description: Get organisation details for the currently logged-in user (both User and Admin)
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Organisation details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Organisation"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not assigned to any organisation or organisation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/availability-config:
    post:
      tags:
        - Availability
      summary: Create availability configuration
      description: |
        Create system-wide availability configuration for the authenticated user.
        This configuration defines when the user is available for matches.

        **Required for matching**: Users without availability configuration will not be matched.

        **Matching logic**: A match is created only when both users have availability configuration AND have at least one common time slot.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAvailabilityConfigInput"
      responses:
        "201":
          description: Availability configuration created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserAvailabilityConfig"
        "400":
          description: Bad request - at least one slot must be selected
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Configuration already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    get:
      tags:
        - Availability
      summary: Get availability configuration
      description: Get the availability configuration for the authenticated user
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Availability configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserAvailabilityConfig"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Configuration not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    put:
      tags:
        - Availability
      summary: Update availability configuration
      description: |
        Update availability configuration for the authenticated user.
        Only provided fields will be updated (partial update).
        At least one time slot must remain selected after the update.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateAvailabilityConfigInput"
      responses:
        "200":
          description: Configuration updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserAvailabilityConfig"
        "400":
          description: Bad request - at least one slot must be selected
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Configuration not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      tags:
        - Availability
      summary: Delete availability configuration
      description: Delete the availability configuration for the authenticated user. User will not be matched until a new configuration is created.
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Configuration deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Availability configuration deleted successfully
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Configuration not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/availability-config/check:
    get:
      tags:
        - Availability
      summary: Check if user has availability configuration
      description: Check whether the authenticated user has created an availability configuration
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Has configuration status
          content:
            application/json:
              schema:
                type: object
                properties:
                  hasConfig:
                    type: boolean
                    example: true
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/dashboard:
    get:
      tags:
        - Admin
      summary: Admin dashboard
      description: Admin dashboard endpoint (requires admin role)
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Dashboard data
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Welcome to admin dashboard
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/import-csv:
    post:
      tags:
        - Admin
      summary: Import users from CSV
      description: Bulk import users from CSV file (admin only, requires organisation)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: CSV file with format firstName,lastName,email
      responses:
        "200":
          description: Users imported successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Users imported successfully
                  count:
                    type: integer
                    example: 10
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/confirm-user:
    post:
      tags:
        - Admin
      summary: Confirm imported user
      description: Confirm a user that was imported via CSV (admin only, same organisation)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: integer
                  example: 5
      responses:
        "200":
          description: User confirmed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User confirmed successfully
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required or wrong organisation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/users:
    get:
      tags:
        - Admin
      summary: Get users by organisation
      description: Get all users belonging to the current user's organisation (admin only)
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of users
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: "#/components/schemas/User"
                  count:
                    type: integer
                    example: 10
        "400":
          description: User not assigned to any organisation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      tags:
        - Admin
      summary: Create a new user
      description: Create a new user in the admin's organisation (admin only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - firstName
                - lastName
                - email
              properties:
                firstName:
                  type: string
                  example: John
                lastName:
                  type: string
                  example: Doe
                email:
                  type: string
                  format: email
                  example: john.doe@example.com
      responses:
        "201":
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Bad request or admin not assigned to organisation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: User with this email already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/users/{id}:
    delete:
      tags:
        - Admin
      summary: Delete a user
      description: Delete a user from the admin's organisation (admin only)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: User ID to delete
          example: 5
      responses:
        "200":
          description: User deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User deleted successfully
        "400":
          description: Bad request or user not in same organisation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/users/{userId}/tags:
    patch:
      tags:
        - Admin
      summary: Update user tags
      description: |
        Update tags for a user in the admin's organisation.

        **Behavior**:
        - Removes all existing tags from the user
        - Creates new tags if they don't exist
        - Assigns all specified tags to the user

        **Use case**: Tags are used for matching algorithm to calculate compatibility scores.
        Users with similar tags will have higher match scores.
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: integer
          description: User ID to update tags for
          example: 5
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tags
              properties:
                tags:
                  type: array
                  items:
                    type: string
                  description: Array of tag names to assign to the user
                  example: ["developer", "senior", "backend"]
      responses:
        "200":
          description: Tags updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Tags updated successfully
        "400":
          description: Bad request or user not in same organisation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/organisation:
    get:
      tags:
        - Admin
      summary: Get organisation
      description: Get organisation details for the currently logged-in user (admin only, alias for backward compatibility)
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Organisation details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Organisation"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not assigned to any organisation or organisation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    put:
      tags:
        - Admin
      summary: Upsert organisation
      description: Create or update organisation (admin only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                id:
                  type: integer
                  description: Organisation ID (required for update, omit for create)
                  example: 1
                name:
                  type: string
                  description: Organisation name
                  example: My Company
                companyUrl:
                  type: string
                  description: Company website URL
                  example: https://mycompany.com
      responses:
        "200":
          description: Organisation created or updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Organisation"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/matches/current:
    get:
      tags:
        - User
        - Matches
      summary: Get current match
      description: |
        Retrieve the current match for the authenticated user.

        **Current match logic**:
        - Returns matches with status "pending" (waiting for acceptance)
        - Returns matches with status "waiting_for_feedback" (both users accepted, waiting for feedback)
        - Does not return matches after both users have submitted feedback (completed)
        - Matches expire 5 days after both users accept (expires_at), but remain "current" until feedback is submitted

        **Returns**:
        - Match details including both users' information
        - **Both users' availability configurations** (availabilityConfig) showing common time slots
        - Match score and scheduled date/time
        - Status ("pending" or "accepted")
        - User tags

        **Note**: Users can only have one current match at a time. After both users submit feedback,
        the system automatically tries to generate a new match for each user.
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Current pending match
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Match"
        "204":
          description: No pending match found (No Content)
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/matches/history:
    get:
      tags:
        - User
        - Matches
      summary: Get match history
      description: |
        Retrieve complete match history for the authenticated user.

        **Returns**:
        - All matches (pending, accepted, rejected, expired)
        - Chronological order (newest first)
        - Full details of each match including other user's information
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Match history
          content:
            application/json:
              schema:
                type: object
                properties:
                  matches:
                    type: array
                    items:
                      $ref: "#/components/schemas/Match"
                  count:
                    type: integer
                    example: 5
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/matches/{id}/accept:
    patch:
      tags:
        - User
        - Matches
      summary: Accept a match
      description: |
        Accept a pending match as the authenticated user.

        **Two-step acceptance process**:
        1. First user accepts → Match remains "pending"
        2. Second user accepts → Match status changes to "waiting_for_feedback", expires_at set to 5 days from now

        **Match expiration**:
        - Once both users accept, the match becomes "waiting_for_feedback"
        - Users have 5 days to submit feedback
        - After 5 days, the match expires but remains visible in history
        - Email notification is sent to both users

        **Availability information**:
        - Both users' system-wide availability configurations are included in the match response
        - No need to provide availability when accepting - it's already configured in user profiles
        - Match was created only because both users have common availability time slots

        **Requirements**:
        - Match must be in "pending" status
        - User must be one of the participants in the match
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: Match ID to accept
          example: 1
      responses:
        "200":
          description: Match accepted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Match accepted successfully
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Unauthorized to modify this match
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Match not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/matches/{id}/reject:
    patch:
      tags:
        - User
        - Matches
      summary: Reject a match
      description: |
        Reject a pending match as the authenticated user.

        **Requirements**:
        - Match must be in "pending" status
        - User must be one of the participants in the match

        **Result**:
        - Match status changes to "rejected"
        - Both users can be matched with others in future rounds
        - 30-day cooldown still applies between these two users
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: Match ID to reject
          example: 1
      responses:
        "200":
          description: Match rejected successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Match rejected successfully
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Unauthorized to modify this match
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Match not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/matches/{id}/availabilities:
    get:
      tags:
        - User
        - Matches
      summary: Get availabilities for a match
      description: |
        Retrieve all availabilities submitted by both users for a specific match.

        **Requirements**:
        - User must be one of the participants in the match

        **Returns**:
        - List of availabilities (can be empty if no one has submitted yet)
        - Each availability includes user info and their time slots
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: Match ID
          example: 1
      responses:
        "200":
          description: Availabilities retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  availabilities:
                    type: array
                    items:
                      $ref: "#/components/schemas/MatchAvailability"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Unauthorized to view this match
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Match not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/matches/{id}/feedback:
    post:
      tags:
        - User
        - Matches
      summary: Submit feedback for a match
      description: |
        Submit rating and optional comment for a completed match.

        **Requirements**:
        - Match must have status "accepted" (both users accepted)
        - User must be one of the participants in the match
        - User must not have already submitted feedback for this match

        **Mandatory feedback**:
        - Both users should provide feedback after accepting a match
        - Use GET /api/matches/pending-feedback to see matches awaiting feedback

        **Rating impact**:
        - Rating updates the other user's averageRating field
        - Average is calculated from all feedbacks received

        **Automatic new match generation**:
        - When both users have submitted feedback, the system automatically tries to generate new matches for both users
        - If suitable candidates are found, new matches are created immediately
        - If no suitable candidates are available, users simply won't have a current match (no error)
        - Match generation is asynchronous and silent - it happens in the background
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: Match ID
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - rating
              properties:
                rating:
                  type: integer
                  description: Rating from 1 to 5 stars
                  example: 4
                  minimum: 1
                  maximum: 5
                comment:
                  type: string
                  description: Optional feedback comment
                  example: "Great conversation about backend architecture!"
      responses:
        "201":
          description: Feedback submitted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Feedback submitted successfully
        "400":
          description: Bad request - invalid rating or match not accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Unauthorized to provide feedback for this match
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Match not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Feedback already submitted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/matches/{id}/feedbacks:
    get:
      tags:
        - User
        - Matches
      summary: Get feedbacks for a match
      description: |
        Retrieve all feedbacks submitted for a specific match.

        **Requirements**:
        - User must be one of the participants in the match

        **Returns**:
        - List of feedbacks (can contain 0, 1, or 2 feedbacks)
        - Each feedback includes rating, comment, and user info
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: Match ID
          example: 1
      responses:
        "200":
          description: Feedbacks retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  feedbacks:
                    type: array
                    items:
                      $ref: "#/components/schemas/MatchFeedback"
                  count:
                    type: integer
                    example: 2
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Unauthorized to view feedbacks for this match
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Match not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/matches/pending-feedback:
    get:
      tags:
        - User
        - Matches
      summary: Get matches pending feedback
      description: |
        Retrieve all accepted matches that the user hasn't provided feedback for yet.

        **Use case**:
        - Display a reminder to users to submit feedback
        - Track which matches need feedback

        **Returns**:
        - List of matches awaiting feedback
        - Only includes accepted matches (both users accepted)
        - Only includes matches where user hasn't submitted feedback
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Pending feedback matches retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  matches:
                    type: array
                    items:
                      $ref: "#/components/schemas/Match"
                  count:
                    type: integer
                    example: 1
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/matches/generate:
    post:
      tags:
        - Admin
        - Matches
      summary: Generate matches for organisation
      description: |
        Manually generate matches for all eligible users in the admin's organisation.

        **Note**: This endpoint generates matches only for the admin's organisation.
        For generating matches across all organisations, use `/api/admin/matches/trigger-scheduler`.

        **Eligibility criteria**:
        - User must be confirmed
        - User must not have a pending match
        - User must not have been matched with the same person in the last 30 days

        **Matching algorithm**:
        - Calculates match score based on tag similarity (Jaccard index)
        - Selects best non-conflicting pairs (each user appears max once)
        - Creates matches with random dates/times (weekdays, business hours)
        - Sends email notifications to both users
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Matches generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Matches generated successfully
                  count:
                    type: integer
                    example: 10
        "400":
          description: Bad request or not enough users to match
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/matches/trigger-scheduler:
    post:
      tags:
        - Admin
        - Matches
      summary: Trigger match scheduler manually
      description: |
        Manually trigger the automatic match scheduler to generate matches for **all organisations** immediately.

        **Difference from `/api/admin/matches/generate`**:
        - This endpoint processes **all organisations** in the system
        - `/generate` only processes the admin's organisation

        **Scheduler behavior**:
        - Runs asynchronously in background
        - Iterates through all organisations
        - Generates matches for each organisation independently
        - Logs detailed information about the process

        **Normal schedule**: The scheduler runs automatically every 30 minutes.
        This endpoint allows manual triggering for testing or immediate match generation.
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Scheduler triggered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Scheduler triggered successfully - matches will be generated for all organisations
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error - Scheduler not initialized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/matches:
    get:
      tags:
        - Admin
        - Matches
      summary: Get all matches for organisation
      description: |
        Retrieve all matches for the admin's organisation with detailed information.

        **Returns**:
        - List of all matches (pending, accepted, rejected, expired)
        - User details for both participants
        - Match scores and scheduled dates/times
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of matches
          content:
            application/json:
              schema:
                type: object
                properties:
                  matches:
                    type: array
                    items:
                      $ref: "#/components/schemas/Match"
                  count:
                    type: integer
                    example: 10
        "400":
          description: Bad request or admin not assigned to organisation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/matches/{id}/feedbacks:
    get:
      tags:
        - Admin
        - Matches
      summary: Get feedbacks for a match (Admin)
      description: |
        Retrieve all feedbacks for a specific match. Admin can view all feedbacks including comments.

        **Admin capabilities**:
        - View feedbacks for any match in their organisation
        - See both rating and comment from each user
        - Useful for monitoring match quality and user satisfaction
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: Match ID
          example: 1
      responses:
        "200":
          description: Feedbacks retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  feedbacks:
                    type: array
                    items:
                      $ref: "#/components/schemas/MatchFeedback"
                  count:
                    type: integer
                    example: 2
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        firstName:
          type: string
          example: John
        lastName:
          type: string
          example: Doe
        email:
          type: string
          format: email
          example: user@example.com
        accountType:
          type: string
          enum: [User, Admin]
          example: User
        organisationId:
          type: integer
          example: 1
        organisation:
          $ref: "#/components/schemas/Organisation"
        tags:
          type: array
          items:
            $ref: "#/components/schemas/Tag"
          description: Tags assigned to the user
        isConfirmed:
          type: boolean
          example: true
        averageRating:
          type: number
          format: float
          description: Average rating received from other users (1-5 scale)
          example: 4.25
          minimum: 1
          maximum: 5
          nullable: true
        availabilityConfig:
          $ref: "#/components/schemas/UserAvailabilityConfig"
          description: User's system-wide availability configuration (null if not set)
          nullable: true
        createdAt:
          type: string
          format: date-time
          example: "2025-12-11T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-12-11T10:00:00Z"

    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT access token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refreshToken:
          type: string
          description: Refresh token for getting new access tokens
          example: zf2KhgQv77eWzy8Yws7wZa8hkv9M7qUxFAyHaNRSC4E=
        user:
          $ref: "#/components/schemas/User"

    Organisation:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: My Company
        companyUrl:
          type: string
          example: https://mycompany.com
        createdAt:
          type: string
          format: date-time
          example: "2025-12-12T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-12-12T10:00:00Z"

    Tag:
      type: object
      description: |
        User tag for categorization and matching.
        Tags are used to calculate match compatibility scores.
        Multiple users can share the same tag (many-to-many relationship).
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          description: Tag name (e.g., "developer", "designer", "manager")
          example: developer
        organisationId:
          type: integer
          description: Organisation that owns this tag
          example: 1
        createdAt:
          type: string
          format: date-time
          example: "2025-12-15T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-12-15T10:00:00Z"

    Match:
      type: object
      description: |
        Represents a match between two users in the same organisation.
        Matches are generated automatically every Monday at 9 AM or manually by admins.
      properties:
        id:
          type: integer
          example: 1
        organisationId:
          type: integer
          example: 1
        user1Id:
          type: integer
          example: 10
        user2Id:
          type: integer
          example: 15
        user1:
          $ref: "#/components/schemas/User"
          description: First user in the match
        user2:
          $ref: "#/components/schemas/User"
          description: Second user in the match
        matchScore:
          type: number
          format: float
          description: |
            Match compatibility score (0-100) calculated using Jaccard similarity on user tags.
            Formula: (common tags / total unique tags) * 100
          example: 75.5
          minimum: 0
          maximum: 100
        user1Accepted:
          type: boolean
          description: Whether user1 has accepted the match
          example: false
        user2Accepted:
          type: boolean
          description: Whether user2 has accepted the match
          example: false
        user1AcceptedAt:
          type: string
          format: date-time
          description: Timestamp when user1 accepted the match
          example: "2025-12-16T10:30:00Z"
          nullable: true
        user2AcceptedAt:
          type: string
          format: date-time
          description: Timestamp when user2 accepted the match
          example: "2025-12-16T11:15:00Z"
          nullable: true
        expiresAt:
          type: string
          format: date-time
          description: |
            Expiration timestamp for accepted matches.
            Set to 5 days after both users accept the match.
            After this time, the match is no longer considered "current".
          example: "2025-12-21T11:15:00Z"
          nullable: true
        availabilities:
          type: array
          items:
            $ref: "#/components/schemas/MatchAvailability"
          description: |
            Availabilities submitted by both users (if any).
            Array can contain 0, 1, or 2 items depending on how many users have submitted their availability.
        feedbacks:
          type: array
          items:
            $ref: "#/components/schemas/MatchFeedback"
          description: |
            Feedbacks submitted by both users (if any).
            Array can contain 0, 1, or 2 items depending on how many users have submitted feedback.
            Visible in match history and for admins.
        status:
          type: string
          enum: [pending, accepted, rejected, expired, waiting_for_feedback, completed]
          description: |
            Match status:
            - pending: Match created, waiting for user action (or one user accepted, waiting for the other)
            - accepted: DEPRECATED - not used anymore (both users now go directly to waiting_for_feedback)
            - rejected: At least one user rejected the match
            - expired: Match expired (no action taken)
            - waiting_for_feedback: Both users accepted the match, waiting for feedback (expires 5 days after acceptance)
            - completed: Both users submitted feedback
          example: pending
        scheduledDate:
          type: string
          format: date-time
          description: Suggested date for the meeting (random weekday, 1-5 days ahead)
          example: "2025-12-18T00:00:00Z"
        scheduledTime:
          type: string
          description: Suggested time slot for the meeting (random, between 9 AM - 5 PM)
          example: "2 PM"
        createdAt:
          type: string
          format: date-time
          example: "2025-12-15T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-12-15T10:00:00Z"

    MatchAvailability:
      type: object
      description: |
        Represents a user's availability for a specific match.
        Each user provides their available time slots when accepting a match.
      properties:
        id:
          type: integer
          example: 1
        matchId:
          type: integer
          example: 5
        userId:
          type: integer
          example: 10
        user:
          $ref: "#/components/schemas/User"
          description: User who provided this availability
        availability:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: |
            Available time slots organized by weekday.
            - Keys: Weekday name (Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday)
            - Values: Array of time periods ("morning" for przed południem, "afternoon" for po południu)
          example:
            "Monday": ["morning", "afternoon"]
            "Wednesday": ["afternoon"]
            "Friday": ["morning"]
        createdAt:
          type: string
          format: date-time
          example: "2025-12-16T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-12-16T10:30:00Z"

    MatchFeedback:
      type: object
      description: |
        Represents feedback submitted by a user for a completed match.
        Both users must submit feedback after the match expires (mandatory).
      properties:
        id:
          type: integer
          example: 1
        matchId:
          type: integer
          example: 5
        userId:
          type: integer
          example: 10
        user:
          $ref: "#/components/schemas/User"
          description: User who submitted this feedback
        rating:
          type: integer
          description: Rating from 1 to 5 stars
          example: 4
          minimum: 1
          maximum: 5
        comment:
          type: string
          description: Optional feedback comment
          example: "Great conversation about backend architecture!"
        createdAt:
          type: string
          format: date-time
          example: "2025-12-21T14:30:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-12-21T14:30:00Z"

    UserAvailabilityConfig:
      type: object
      description: |
        User's system-wide availability configuration.
        Defines when the user is available for matches (days and time periods).
        Required for the matching algorithm - users without configuration will not be matched.
      properties:
        id:
          type: integer
          example: 1
        userId:
          type: integer
          example: 5
        mondayMorning:
          type: boolean
          example: true
        mondayAfternoon:
          type: boolean
          example: false
        tuesdayMorning:
          type: boolean
          example: true
        tuesdayAfternoon:
          type: boolean
          example: true
        wednesdayMorning:
          type: boolean
          example: false
        wednesdayAfternoon:
          type: boolean
          example: true
        thursdayMorning:
          type: boolean
          example: false
        thursdayAfternoon:
          type: boolean
          example: false
        fridayMorning:
          type: boolean
          example: true
        fridayAfternoon:
          type: boolean
          example: true
        saturdayMorning:
          type: boolean
          example: false
        saturdayAfternoon:
          type: boolean
          example: false
        sundayMorning:
          type: boolean
          example: false
        sundayAfternoon:
          type: boolean
          example: false
        createdAt:
          type: string
          format: date-time
          example: "2026-01-06T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2026-01-06T10:30:00Z"

    CreateAvailabilityConfigInput:
      type: object
      description: |
        Input for creating availability configuration.
        At least one time slot must be set to true.
      properties:
        mondayMorning:
          type: boolean
          default: false
        mondayAfternoon:
          type: boolean
          default: false
        tuesdayMorning:
          type: boolean
          default: false
        tuesdayAfternoon:
          type: boolean
          default: false
        wednesdayMorning:
          type: boolean
          default: false
        wednesdayAfternoon:
          type: boolean
          default: false
        thursdayMorning:
          type: boolean
          default: false
        thursdayAfternoon:
          type: boolean
          default: false
        fridayMorning:
          type: boolean
          default: false
        fridayAfternoon:
          type: boolean
          default: false
        saturdayMorning:
          type: boolean
          default: false
        saturdayAfternoon:
          type: boolean
          default: false
        sundayMorning:
          type: boolean
          default: false
        sundayAfternoon:
          type: boolean
          default: false
      example:
        mondayMorning: true
        mondayAfternoon: false
        tuesdayMorning: true
        tuesdayAfternoon: true
        wednesdayMorning: false
        wednesdayAfternoon: true
        thursdayMorning: false
        thursdayAfternoon: false
        fridayMorning: true
        fridayAfternoon: true
        saturdayMorning: false
        saturdayAfternoon: false
        sundayMorning: false
        sundayAfternoon: false

    UpdateAvailabilityConfigInput:
      type: object
      description: |
        Input for updating availability configuration.
        Only provided fields will be updated (partial update).
        At least one time slot must remain true after the update.
      properties:
        mondayMorning:
          type: boolean
          nullable: true
        mondayAfternoon:
          type: boolean
          nullable: true
        tuesdayMorning:
          type: boolean
          nullable: true
        tuesdayAfternoon:
          type: boolean
          nullable: true
        wednesdayMorning:
          type: boolean
          nullable: true
        wednesdayAfternoon:
          type: boolean
          nullable: true
        thursdayMorning:
          type: boolean
          nullable: true
        thursdayAfternoon:
          type: boolean
          nullable: true
        fridayMorning:
          type: boolean
          nullable: true
        fridayAfternoon:
          type: boolean
          nullable: true
        saturdayMorning:
          type: boolean
          nullable: true
        saturdayAfternoon:
          type: boolean
          nullable: true
        sundayMorning:
          type: boolean
          nullable: true
        sundayAfternoon:
          type: boolean
          nullable: true
      example:
        mondayMorning: false
        tuesdayAfternoon: true

    Error:
      type: object
      properties:
        error:
          type: string
          example: Error message description
