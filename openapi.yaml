openapi: 3.0.3
info:
  title: Virtual Cuppa API
  description: Backend API for Virtual Cuppa application with email-based authentication
  version: 1.0.0
  contact:
    email: noreply@notacv.com

servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Authentication
    description: User authentication and registration endpoints
  - name: User
    description: User profile endpoints
  - name: Admin
    description: Admin-only endpoints

paths:
  /health:
    get:
      summary: Health check
      description: Check if the server is running
      responses:
        "200":
          description: Server is running
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  message:
                    type: string
                    example: Server is running

  /api/auth/register:
    post:
      tags:
        - Authentication
      summary: Register a new user
      description: Register a new Admin account. A confirmation code will be sent to the user's email. After registration, user must login to receive access tokens.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                firstName:
                  type: string
                  example: John
                lastName:
                  type: string
                  example: Doe
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        "201":
          description: Registration successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Registration successful. Confirmation code sent to email
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: User already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/auth/request-code:
    post:
      tags:
        - Authentication
      summary: Request a confirmation code
      description: Request a 6-digit confirmation code to be sent via email (valid for 5 minutes)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        "200":
          description: Confirmation code sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Confirmation code sent to email
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/auth/login:
    post:
      tags:
        - Authentication
      summary: Login with confirmation code
      description: Login using email and 6-digit confirmation code received via email
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - confirmCode
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                confirmCode:
                  type: string
                  minLength: 6
                  maxLength: 6
                  example: "123456"
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: Get a new access token using refresh token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
                  example: refresh.token.here
      responses:
        "200":
          description: Token refreshed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "401":
          description: Invalid refresh token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/profile:
    get:
      tags:
        - User
      summary: Get current user profile
      description: Get the profile of the currently authenticated user
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/organisation:
    get:
      tags:
        - User
      summary: Get organisation
      description: Get organisation details for the currently logged-in user (both User and Admin)
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Organisation details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Organisation"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not assigned to any organisation or organisation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/dashboard:
    get:
      tags:
        - Admin
      summary: Admin dashboard
      description: Admin dashboard endpoint (requires admin role)
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Dashboard data
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Welcome to admin dashboard
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/import-csv:
    post:
      tags:
        - Admin
      summary: Import users from CSV
      description: Bulk import users from CSV file (admin only, requires organisation)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: CSV file with format firstName,lastName,email
      responses:
        "200":
          description: Users imported successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Users imported successfully
                  count:
                    type: integer
                    example: 10
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/confirm-user:
    post:
      tags:
        - Admin
      summary: Confirm imported user
      description: Confirm a user that was imported via CSV (admin only, same organisation)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: integer
                  example: 5
      responses:
        "200":
          description: User confirmed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User confirmed successfully
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required or wrong organisation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/users:
    get:
      tags:
        - Admin
      summary: Get users by organisation
      description: Get all users belonging to the current user's organisation (admin only)
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of users
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: "#/components/schemas/User"
                  count:
                    type: integer
                    example: 10
        "400":
          description: User not assigned to any organisation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      tags:
        - Admin
      summary: Create a new user
      description: Create a new user in the admin's organisation (admin only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - firstName
                - lastName
                - email
              properties:
                firstName:
                  type: string
                  example: John
                lastName:
                  type: string
                  example: Doe
                email:
                  type: string
                  format: email
                  example: john.doe@example.com
      responses:
        "201":
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Bad request or admin not assigned to organisation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: User with this email already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/users/{id}:
    delete:
      tags:
        - Admin
      summary: Delete a user
      description: Delete a user from the admin's organisation (admin only)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: User ID to delete
          example: 5
      responses:
        "200":
          description: User deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User deleted successfully
        "400":
          description: Bad request or user not in same organisation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/users/{userId}/tags:
    patch:
      tags:
        - Admin
      summary: Update user tags
      description: Update tags for a user in the admin's organisation (admin only)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: integer
          description: User ID to update tags for
          example: 5
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tags
              properties:
                tags:
                  type: array
                  items:
                    type: string
                  description: Array of tag names to assign to the user
                  example: ["developer", "senior", "backend"]
      responses:
        "200":
          description: Tags updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Tags updated successfully
        "400":
          description: Bad request or user not in same organisation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/admin/organisation:
    put:
      tags:
        - Admin
      summary: Upsert organisation
      description: Create or update organisation (admin only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                id:
                  type: integer
                  description: Organisation ID (required for update, omit for create)
                  example: 1
                name:
                  type: string
                  description: Organisation name
                  example: My Company
                companyUrl:
                  type: string
                  description: Company website URL
                  example: https://mycompany.com
      responses:
        "200":
          description: Organisation created or updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Organisation"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        firstName:
          type: string
          example: John
        lastName:
          type: string
          example: Doe
        email:
          type: string
          format: email
          example: user@example.com
        accountType:
          type: string
          enum: [User, Admin]
          example: User
        organisationId:
          type: integer
          example: 1
        organisation:
          $ref: "#/components/schemas/Organisation"
        tags:
          type: array
          items:
            $ref: "#/components/schemas/Tag"
          description: Tags assigned to the user
        isConfirmed:
          type: boolean
          example: true
        createdAt:
          type: string
          format: date-time
          example: "2025-12-11T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-12-11T10:00:00Z"

    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT access token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refreshToken:
          type: string
          description: Refresh token for getting new access tokens
          example: zf2KhgQv77eWzy8Yws7wZa8hkv9M7qUxFAyHaNRSC4E=
        user:
          $ref: "#/components/schemas/User"

    Organisation:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: My Company
        companyUrl:
          type: string
          example: https://mycompany.com
        createdAt:
          type: string
          format: date-time
          example: "2025-12-12T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-12-12T10:00:00Z"

    Tag:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: developer
        organisationId:
          type: integer
          example: 1
        createdAt:
          type: string
          format: date-time
          example: "2025-12-15T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-12-15T10:00:00Z"

    Error:
      type: object
      properties:
        error:
          type: string
          example: Error message description
